<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/utils/flush.html">
<link rel="import" href="../shadycss/apply-shim.html">

<link rel="import" href="../flexible-rating/flexible-rating.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../iron-jsonp-library/iron-jsonp-library.html">


<!--
An element providing a form for the evaluation of a course.

Example:

    <mammooc-course-evaluation-form></mammooc-course-evaluation-form>


-->
<dom-module id="mammooc-course-evaluation-form">
    <template>
        <style>
            :host {
                    --iron-icon-height: 40px;
                    --iron-icon-width: 40px;
                    --primary-color: var(--mammooc-rating-widget-primary-color, #ffac33);
            }

            .heading {
                @apply --paper-font-headline;
            }

            .submit-button {
                float: right;
            }

            #form img {
                float: left;
                width: 80px;
                height: 80px;
                border-radius: 50%;
                margin-right: 5px;
                border: 1px solid var(--mammooc-rating-widget-secondary-color, #9999);
            }

            #form .description {
                overflow: auto;
            }
        </style>

        <!-- Library for loading the data from mammooc -->
        <iron-jsonp-library id="evaluationRequest"
            library-url="{{_generateUrl(provider, courseId)}}"
            notify-event="api-load">
        </iron-jsonp-library>
        <!-- local DOM goes here -->
        <div class="heading">
            {{localize("yourrating")}}
        </div>
        <iron-form id="form">
            <form>
                <div>
                    <template is="dom-if" if="{{loggedIn}}">
                        <img id="profile_image"></img>
                        <div id="profile_name"></div>
                    </template>
                    <div class="description">
                        <paper-textarea placeholder="{{localize('descriptionplaceholder')}}" name="description" label="{{localize('descriptionlabel')}}" id="description"></paper-textarea>
                    </div>
                </div>
                <label id="statusLabel">
                    {{localize("status")}}
                    </label>
                <paper-radio-group id="status" aria-labelledby="statusLabel" selected="enrolled">
                    <paper-radio-button name="aborted">
                        {{localize("aborted")}}
                    </paper-radio-button>
                    <paper-radio-button name="enrolled">
                        {{localize("enrolled")}}
                    </paper-radio-button>
                    <paper-radio-button name="finished">
                        {{localize("finished")}}
                    </paper-radio-button>
                </paper-radio-group>
                <paper-checkbox id="anonymously" name="anonymously">
                    {{localize("submitanonymously")}}
                </paper-checkbox>
                <flexible-rating id="stars" name="stars" required></flexible-rating>
                <paper-button class="submit-button" raised on-click="_submitForm">
                    {{localize("submit")}}
                </paper-button>
            </form>
        </iron-form>

        <!-- Send form if user is not logged in -->
        <form method="post" target="_blank" action="https://mammooc-dev.herokuapp.com/evaluations/login_and_save" id="nativeForm">
        </form>

        <!-- Callback for finished post, flashes success message -->
        <iron-jsonp-library id="postJsonP"
            callback-name="callback"
            notify-event="post-sent">
        </iron-jsonp-library>

        <paper-toast id="successToast" text="{{localize('successtext')}}"></paper-toast>

    </template>

    <script>
        "use strict";
        class MammoocCourseEvaluationForm extends Polymer.mixinBehaviors([
            MammoocLocalizeBehavior,
            Polymer.IronJsonpLibraryBehavior
        ], Polymer.Element) {

            static get is() {
                return 'mammooc-course-evaluation-form';
            }

            static get properties() {
                return {
                    /**
                     *    The provider of the course, e.g. "openHPI"
                     */
                    provider: {
                        type: String
                    },

                    /**
                     *   The ID of the course in the provider's system
                     */
                    courseId: {
                        type: String
                    },

                    /**
                     *   A boolean stating whether the user is logged in on mammooc
                     */
                    loggedIn: {
                        type: Boolean,
                        value: false,
                        readOnly: true
                    },

                    _tries: {
                        type: Number,
                        value: 0
                    }
                }
            }

            static get observers() {
                return [
                ]
            }

            ready() {
                this.addEventListener('api-load', this._apiLoaded.bind(this));
                this.addEventListener('post-sent', this._postSent.bind(this));
                // Every time the window gets focus, send a new request in case of changes on mammooc
                // _tries is needed because the jsonp library won't resend if the url is the same
                let e = this;
                window.onfocus = function() {
                    e.$.evaluationRequest.libraryUrl = e._generateUrl(e.provider, e.courseId) + '&try=' + e._tries;
                    e._tries += 1;
                };
                super.ready()
            }

            _postSent(event) {
                this.parentNode.parentNode.parentNode.querySelector('#evaluationsXHR').generateRequest();
                this.$.successToast.open();
            }

            _submitForm() {
                if (this.loggedIn)
                    this._jsonPSubmit();
                else
                    this._nativeSubmit();
            }

            _jsonPSubmit() {
                const serializedItems = this._serializeFormData();
                let url = "https://mammooc-dev.herokuapp.com/evaluations/save.js?callback=callback&";
                url = url + Object.keys(serializedItems).map(function(k) {
                    return encodeURIComponent(k) + '=' + encodeURIComponent(serializedItems[k])
                }).join('&');
                this.shadowRoot.querySelector('#postJsonP').libraryUrl = url;
            }

            _serializeFormData() {
                const formData = this.$.form.serializeForm();
                let newFormData = {};

                if (formData['description'] !== undefined && formData['description'] !== null && formData['description'] !==  '') {
                    newFormData['description'] = formData['description'];
                }
                newFormData['rating'] = formData['stars'];
                newFormData['rated_anonymously'] = formData['anonymously'] === 'on';

                newFormData['course_status'] = this.shadowRoot.querySelector('#status').selected;

                newFormData['course_id'] = this.courseId;
                newFormData['provider'] = this.provider;

                return newFormData;
            }

            _nativeSubmit() {
                const form = this.$.form;
                let nativeForm = this.$.nativeForm;

                while (nativeForm.firstChild) {
                    nativeForm.removeChild(nativeForm.firstChild);
                }

                if (form.validate()) {
                    // For each element the iron-form wants to submit, create a hidden
                    // input in the submission form.
                    const serializedItems = this._serializeFormData();

                    for (const name in serializedItems) {
                        let input = document.createElement('input');
                        input.hidden = true;
                        input.name = name;
                        input.value = serializedItems[name];
                        nativeForm.appendChild(input);
                    }
                    nativeForm.submit();
                }
            }

            _generateUrl(provider, courseId) {
                return 'https://mammooc-dev.herokuapp.com/api/current_user_with_evaluation.js?provider='+this.provider + '&course_id=' + this.courseId+'&callback=%%callback%%';
            }

            _apiLoaded(response) {
                const result = response.detail[0];
                this._setLoggedIn(result.logged_in);
                Polymer.flush();
                if (!this.loggedIn) {
                    return;
                }
                this.shadowRoot.querySelector('#profile_image').src = result.user.profile_picture;
                this.shadowRoot.querySelector('#profile_name').innerHTML = result.user.name;
                this.shadowRoot.querySelector('#description').value = result.evaluation.description;
                this.shadowRoot.querySelector('#stars').value = result.evaluation.rating;
                this.shadowRoot.querySelector('#status').selected = result.evaluation.course_status;
                this.shadowRoot.querySelector('#anonymously').checked = result.evaluation.rated_anonymously;
            }
        }

        // Register custom element definition using standard platform API
        customElements.define(MammoocCourseEvaluationForm.is, MammoocCourseEvaluationForm);
    </script>
</dom-module>
